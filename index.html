<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Guessing Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom class for feedback animation */
        .feedback-pop {
            animation: pop 0.5s ease-out;
        }
        @keyframes pop {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Ensure text is readable on any color button */
        .color-btn-text {
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.5), 0 0 4px rgba(0, 0, 0, 0.5);
        }
         /* Scrollbar styling for color list */
        #color-list-container::-webkit-scrollbar {
            width: 8px;
        }
        #color-list-container::-webkit-scrollbar-track {
            background: #f5f5f5; /* neutral-100 */
            border-radius: 10px;
        }
        #color-list-container::-webkit-scrollbar-thumb {
            background: #a3a3a3; /* neutral-400 */
            border-radius: 10px;
        }
        #color-list-container::-webkit-scrollbar-thumb:hover {
            background: #737373; /* neutral-500 */
        }
        /* Dark mode scrollbar */
        .dark #color-list-container::-webkit-scrollbar-track {
            background: #525252; /* neutral-600 */
        }
        .dark #color-list-container::-webkit-scrollbar-thumb {
            background: #737373; /* neutral-500 */
        }
        .dark #color-list-container::-webkit-scrollbar-thumb:hover {
            background: #a3a3a3; /* neutral-400 */
        }
    </style>
</head>
<body class="bg-neutral-100 dark:bg-neutral-900 text-neutral-900 dark:text-neutral-100 min-h-screen flex items-center justify-center p-4 transition-colors duration-300">

    <div class="max-w-md w-full">
        <h1 class="text-3xl font-bold text-center mb-6">Color Guessing Game</h1>

        <div id="start-screen" class="bg-white dark:bg-neutral-800 rounded-lg shadow-xl p-8 text-center">
            <p class="text-lg mb-6">Guess the color from the name, or the name from the color. You have 20 rounds. Good luck!</p>
            <button id="start-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Start Game
            </button>
            <div class="flex items-center justify-center my-6">
                <label for="hard-mode-toggle" class="flex items-center cursor-pointer">
                    <span class="mr-3 font-semibold text-neutral-700 dark:text-neutral-300">Hard Mode</span>
                    <div class="relative">
                        <input type="checkbox" id="hard-mode-toggle" class="sr-only peer">
                        <div class="w-12 h-7 bg-neutral-300 dark:bg-neutral-600 rounded-full shadow-inner transition-colors peer-checked:bg-red-600 dark:peer-checked:bg-red-500"></div>
                        <div class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full shadow transition-transform peer-checked:translate-x-5"></div>
                    </div>
                </label>
            </div>
            
            <div class="my-6 text-left">
                <label for="library-select" class="block mb-2 font-semibold text-neutral-700 dark:text-neutral-300">Color Library</label>
                <select id="library-select" class="w-full bg-neutral-100 dark:bg-neutral-700 border border-neutral-300 dark:border-neutral-600 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="w3.csv">W3 Colors (147)</option>
                    <option value="hexa.csv">ColorHexa (746)</option>
                    <option value="crayola.csv">Crayola (110)</option>
                    <option value="xkcd.csv">XKCD (949)</option>
                </select>
            </div>
            <button id="help-btn" class="mt-4 text-sm text-blue-600 dark:text-blue-400 hover:underline focus:outline-none">
                Show Color Reference
            </button>
            <div class="mt-4 text-sm text-neutral-600 dark:text-neutral-400">
                <div>Best (Easy): <span id="start-best-score-easy">0</span></div>
                <div>Best (Hard): <span id="start-best-score-hard">0</span></div>
            </div>
        </div>
 
        <div id="game-screen" class="hidden">
            <div class="flex justify-between items-center mb-4 text-sm font-semibold bg-white dark:bg-neutral-800 rounded-lg shadow-lg p-4">
                <div>Score: <span id="score" class="font-bold text-lg text-blue-600 dark:text-blue-400">0</span></div>
                <div>Best: <span id="best-score" class="font-bold text-lg">0</span></div>
                <div>Round: <span id="guesses-left" class="font-bold text-lg">20</span> / 20</div>
            </div>

            <div class="bg-white dark:bg-neutral-800 rounded-lg shadow-xl p-6">
                <h2 id="question-text" class="text-xl font-semibold text-center mb-4 h-12 flex items-center justify-center"></h2>
                
                <div id="color-display" class="w-full h-48 md:h-64 rounded-lg mb-6 shadow-inner bg-neutral-200 dark:bg-neutral-700 flex items-center justify-center text-4xl font-bold text-center px-4" style="text-shadow: 0 0 8px rgba(0,0,0,0.3);">
                </div>

                <div id="options-container" class="grid grid-cols-2 gap-4">
                    </div>

                <div id="feedback" class="mt-6 text-center text-lg font-semibold h-8"></div>
            </div>
        </div>

        <div id="end-screen" class="hidden absolute inset-0 bg-neutral-900 bg-opacity-80 flex items-center justify-center p-4 z-40">
            <div class="bg-white dark:bg-neutral-800 rounded-lg shadow-2xl p-8 text-center w-full max-w-sm">
                <h2 class="text-3xl font-bold mb-4">Game Over!</h2>
                <div id="new-best-score-text" class="text-2xl font-semibold text-yellow-500 mb-4 hidden">New Best Score!</div>
                <div class="text-xl mb-2">Final Score: <span id="final-score" class="font-bold">0</span></div>
                <div class="text-xl mb-6">Your Rank: <span id="rank" class="font-bold"></span></div>
                <div class="text-lg mb-8">
                    <div>Best (Easy): <span id="end-best-score-easy" class="font-bold">0</span></div>
                    <div>Best (Hard): <span id="end-best-score-hard" class="font-bold">0</span></div>
                </div>
                <button id="play-again-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Play Again
                </button>
            </div>
        </div>

        <div id="help-modal" class="hidden absolute inset-0 bg-neutral-900 bg-opacity-80 flex items-center justify-center p-4 z-50">
            <div class="bg-white dark:bg-neutral-800 rounded-lg shadow-2xl p-6 w-full max-w-md relative">
                <h2 class="text-2xl font-bold mb-4 text-center">Color Reference</h2>
                <button id="close-help-btn" class="absolute top-3 right-4 text-neutral-500 hover:text-neutral-800 dark:hover:text-neutral-200 text-3xl font-bold leading-none" aria-label="Close">&times;</button>
                
                <div id="color-list-container" class="max-h-[60vh] overflow-y-auto pr-2">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA: Now loaded from CSV ---
        
        // --- Game State Variables ---
        let currentColorLibrary = []; // This will hold the loaded colors
        let score = 0;
        let guessesLeft = 20;
        let bestScoreEasy = 0;
        let bestScoreHard = 0;
        let currentCorrectColor = null;
        let gameMode = 'colorToName'; // 'colorToName' or 'nameToColor'
        let processingAnswer = false;
        let isHardMode = false;
        const TOTAL_GUESSES = 20;
 
        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        
        const startBtn = document.getElementById('start-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        
        const scoreEl = document.getElementById('score');
        const bestScoreEl = document.getElementById('best-score');
        const startBestScoreEasyEl = document.getElementById('start-best-score-easy');
        const startBestScoreHardEl = document.getElementById('start-best-score-hard');
        const guessesLeftEl = document.getElementById('guesses-left');
        
        const questionTextEl = document.getElementById('question-text');
        const colorDisplayEl = document.getElementById('color-display');
        const optionsContainer = document.getElementById('options-container');
        const feedbackEl = document.getElementById('feedback');
        
        const finalScoreEl = document.getElementById('final-score');
        const rankEl = document.getElementById('rank');
        const endBestScoreEasyEl = document.getElementById('end-best-score-easy');
        const endBestScoreHardEl = document.getElementById('end-best-score-hard');
        const newBestScoreText = document.getElementById('new-best-score-text');

        // Help Modal Elements
        const helpBtn = document.getElementById('help-btn');
        const helpModal = document.getElementById('help-modal');
        const closeHelpBtn = document.getElementById('close-help-btn');
        const colorListContainer = document.getElementById('color-list-container');
        
        // NEW: Library Selector
        const librarySelect = document.getElementById('library-select');
 
        // --- NEW: CSV Loading Functions ---
        
        /**
         * Fetches a CSV file and loads it into the game state.
         * @param {string} filename The path to the .csv file.
         */
        async function loadColorLibrary(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`Failed to load library: ${response.statusText}`);
                }
                const csvText = await response.text();
                const colors = parseCSV(csvText);
                currentColorLibrary = colors; // Update the global state
                
                // Update help modal as requested
                populateColorList();
                
                console.log(`Loaded ${colors.length} colors from ${filename}`);
            } catch (error) {
                console.error("Error loading color library:", error);
                alert(`Could not load color library '${filename}'. Please check the file and try again. Using a fallback list.`);
                // Fallback to a minimal list so the game doesn't break
                currentColorLibrary = [
                    { name: "red", hex: "#ff0000" }, 
                    { name: "green", hex: "#008000" }, 
                    { name: "blue", hex: "#0000ff" }
                ];
                populateColorList();
            }
        }

        /**
         * Parses CSV text into an array of color objects.
         * Assumes "name,hex" header.
         * @param {string} text The raw CSV text.
         */
        function parseCSV(text) {
            const lines = text.split('\n');
            const colors = [];
            // Start from 1 to skip header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // Skip empty lines
                
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const name = parts[0].trim();
                    const hex = parts[1].trim();
                    // Basic validation
                    if (name && hex.startsWith('#')) {
                        colors.push({ name, hex });
                    } else {
                        console.warn(`Skipping malformed CSV line: ${line}`);
                    }
                }
            }
            return colors;
        }

        // --- Utility Functions ---

        /**
         * Converts a camelCase or lowercase string to a "Friendly Title Case" string.
         * e.g., "darkorange" -> "Dark Orange"
         * e.g., "lightgoldenrodyellow" -> "Light Goldenrod Yellow"
         */
        function formatColorName(name) {
            // Insert a space before any uppercase letter (e.g., "lightGoldenrodYellow" -> "light Goldenrod Yellow")
            const spacedName = name.replace(/([A-Z])/g, ' $1');
            // Capitalize the first letter of each word
            return spacedName.replace(/\b(\w)/g, char => char.toUpperCase());
        }
 
        // Load best score from localStorage
        function loadBestScore() {
            bestScoreEasy = localStorage.getItem('colorGameBestScore_easy') || 0;
            bestScoreHard = localStorage.getItem('colorGameBestScore_hard') || 0;
            
            // Update all score displays
            startBestScoreEasyEl.textContent = bestScoreEasy;
            startBestScoreHardEl.textContent = bestScoreHard;
            endBestScoreEasyEl.textContent = bestScoreEasy;
            endBestScoreHardEl.textContent = bestScoreHard;
            
            // Update in-game best score display (will be 0 if game not started, which is fine)
            bestScoreEl.textContent = isHardMode ? bestScoreHard : bestScoreEasy;
        }
 
        // Save best score to localStorage
        function saveBestScore() {
            if (isHardMode) {
                if (score > bestScoreHard) {
                    bestScoreHard = score;
                    localStorage.setItem('colorGameBestScore_hard', bestScoreHard);
                    newBestScoreText.classList.remove('hidden');
                }
            } else {
                if (score > bestScoreEasy) {
                    bestScoreEasy = score;
                    localStorage.setItem('colorGameBestScore_easy', bestScoreEasy);
                    newBestScoreText.classList.remove('hidden');
                }
            }
            // Re-load to ensure end-screen scores are correct
            loadBestScore();
        }
 
        // Get a random element from an array
        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // Shuffle an array (Fisher-Yates)
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
 
        // --- New Help Modal Functions ---
        function populateColorList() {
            const list = document.createElement('div');
            // Changed to a single column layout
            list.className = 'flex flex-col gap-2';
            
            // Sort colors by name for the reference list
            // *** UPDATED: Now uses currentColorLibrary ***
            const sortedColors = [...currentColorLibrary].sort((a, b) => a.name.localeCompare(b.name));

            sortedColors.forEach(color => {
                const item = document.createElement('div');
                // Updated item classes for single column
                item.className = 'flex items-center space-x-4 p-2 bg-neutral-100 dark:bg-neutral-700 rounded-md shadow-sm';
                
                const swatch = document.createElement('div');
                swatch.className = 'w-10 h-10 rounded border border-neutral-300 dark:border-neutral-600 shrink-0';
                swatch.style.backgroundColor = color.hex;
                
                const name = document.createElement('span');
                name.className = 'text-sm font-medium';
                // Use the new formatter
                name.textContent = color.name;
                
                item.appendChild(swatch);
                item.appendChild(name);
                list.appendChild(item);
            });
            colorListContainer.innerHTML = ''; // Clear previous (if any)
            colorListContainer.appendChild(list);
        }

        function showHelpModal() {
            helpModal.classList.remove('hidden');
        }

        function hideHelpModal() {
            helpModal.classList.add('hidden');
        }

        // --- Hard Mode Helper Functions ---

        // Convert hex string to an RGB object
        function hexToRgb(hex) {
            // Ensure hex string is valid
            if (!hex || hex.length !== 7 || hex[0] !== '#') {
                console.error('Invalid hex color:', hex);
                return { r: 0, g: 0, b: 0 }; // Return black as fallback
            }
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return { r, g, b };
        }

        // Calculate Euclidean distance between two color objects
        function colorDistance(color1, color2) {
            const rgb1 = hexToRgb(color1.hex);
            const rgb2 = hexToRgb(color2.hex);
            return Math.sqrt(
                Math.pow(rgb2.r - rgb1.r, 2) +
                Math.pow(rgb2.g - rgb1.g, 2) +
                Math.pow(rgb2.b - rgb1.b, 2)
            );
        }

        // Get the correct color + (num - 1) closest colors from the list
        function getCloseColors(correctColor, num) {
            // 1. Calculate distance from the correct color to all other colors.
            // We filter by hex to avoid comparing a color to itself, 
            // but duplicates (like 'gray' and 'grey') are allowed in the options.
            // *** UPDATED: Now uses currentColorLibrary ***
            const distances = currentColorLibrary
                .filter(color => color.hex !== correctColor.hex) // Exclude exact hex matches
                .map(color => ({
                    color: color,
                    distance: colorDistance(correctColor, color)
                }));

            // 2. Sort by distance (ascending).
            distances.sort((a, b) => a.distance - b.distance);

            // 3. Take the (num - 1) closest colors.
            // We need to handle potential duplicates in the resulting list
            const closestColors = [];
            const addedNames = new Set([correctColor.name]);

            for (const d of distances) {
                if (closestColors.length >= num - 1) break;
                // Only add if the name is not already in our list
                if (!addedNames.has(d.color.name)) {
                    closestColors.push(d.color);
                    addedNames.add(d.color.name);
                }
            }
            
            // 4. If we still don't have enough (e.g., 'gray' and 'grey' were filtered),
            //    fill with random colors that aren't the correct one.
            while (closestColors.length < num - 1) {
                // *** UPDATED: Now uses currentColorLibrary ***
                const randomColor = getRandomElement(currentColorLibrary);
                if (!addedNames.has(randomColor.name)) {
                    closestColors.push(randomColor);
                    addedNames.add(randomColor.name);
                }
            }


            // 5. Return the correct color + the close ones.
            return [correctColor, ...closestColors];
        }
 
        // --- Game Logic Functions ---
 
        function startGame() {
            score = 0;
            guessesLeft = TOTAL_GUESSES;
            scoreEl.textContent = score;
            guessesLeftEl.textContent = guessesLeft;
            newBestScoreText.classList.add('hidden');
            
            // Check if Hard Mode is enabled
            isHardMode = document.getElementById('hard-mode-toggle').checked;
            
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            loadBestScore(); // Load scores
            bestScoreEl.textContent = isHardMode ? bestScoreHard : bestScoreEasy; // Set in-game best
            nextRound();
        }
 
        function nextRound() { 
            if (guessesLeft <= 0) { 
                endGame();
                return;
            }

            // Check if library is too small for 4 options
            if (currentColorLibrary.length < 4) {
                alert("The selected color library is too small to play (requires at least 4 unique colors). Please select a different library.");
                gameScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
                return;
            }

            processingAnswer = false;
            feedbackEl.textContent = '';
            feedbackEl.classList.remove('text-green-500', 'text-red-500', 'feedback-pop');
            optionsContainer.innerHTML = ''; // Clear old options
 
            // 1. Get 4 unique colors (DIFFERENTLY based on mode)
            let chosenColors;
            let options;
            
            // *** UPDATED: Now uses currentColorLibrary ***
            currentCorrectColor = getRandomElement(currentColorLibrary); // Pick the correct answer first

            if (isHardMode) {
                // Hard Mode: Get the 3 colors closest to the correct one
                chosenColors = getCloseColors(currentCorrectColor, 4);
            } else {
                // Normal Mode: Pick 3 other random, unique *names*
                const otherColors = new Set();
                const addedNames = new Set([currentCorrectColor.name]);
                
                while (otherColors.size < 3) {
                    // *** UPDATED: Now uses currentColorLibrary ***
                    const randomColor = getRandomElement(currentColorLibrary);
                    if (!addedNames.has(randomColor.name)) {
                        otherColors.add(randomColor);
                        addedNames.add(randomColor.name);
                    }
                }
                chosenColors = [currentCorrectColor, ...Array.from(otherColors)];
            }
            
            options = shuffleArray(chosenColors);
            
            // 2. Randomly pick game mode
            gameMode = Math.random() < 0.5 ? 'colorToName' : 'nameToColor';

            if (gameMode === 'colorToName') {
                // Mode 1: Show color, guess name
                questionTextEl.textContent = 'What color is this?';
                colorDisplayEl.style.backgroundColor = currentCorrectColor.hex;
                // Check brightness for text color
                const brightness = getBrightness(currentCorrectColor.hex);
                colorDisplayEl.textContent = ''; // No text in swatch
                colorDisplayEl.classList.remove('text-white', 'text-black'); // Clear old classes
                colorDisplayEl.classList.add(brightness > 128 ? 'text-black' : 'text-white');

                // Create name buttons
                options.forEach(color => {
                    const button = document.createElement('button');
                    // Use the new formatter
                    button.textContent = formatColorName(color.name);
                    button.dataset.value = color.name; // Keep raw name in data-value
                    button.className = "option-btn w-full h-20 md:h-24 bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 font-semibold rounded-lg shadow-md transition-all duration-150 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base";
                    button.onclick = () => checkAnswer(color.name);
                    optionsContainer.appendChild(button);
                });

            } else {
                // Mode 2: Show name, guess color
                questionTextEl.textContent = 'Which color is...';
                colorDisplayEl.style.backgroundColor = '';
                // Use the new formatter
                colorDisplayEl.textContent = formatColorName(currentCorrectColor.name);
                colorDisplayEl.classList.remove('text-white', 'text-black');
                colorDisplayEl.classList.add('text-neutral-900', 'dark:text-neutral-100');

                // Create color swatch buttons
                options.forEach(color => {
                    const button = document.createElement('button');
                    button.style.backgroundColor = color.hex;
                    button.dataset.value = color.name; // Use name as value for comparison
                    
                    // Add text with good contrast for accessibility/clarity
                    const brightness = getBrightness(color.hex);
                    const textColorClass = brightness > 128 ? 'text-black' : 'text-white';
                    button.innerHTML = `<span class="opacity-0 group-hover:opacity-100 ${textColorClass} color-btn-text font-semibold text-sm transition-opacity">?</span>`;
                    
                    button.className = `option-btn w-full h-20 md:h-24 font-semibold rounded-lg shadow-md transition-all duration-150 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 group flex items-center justify-center`;
                    button.onclick = () => checkAnswer(color.name);
                    optionsContainer.appendChild(button);
                });
            }
        }
        
        // Helper to get brightness of a hex color (0-255)
        function getBrightness(hex) {
            // Ensure hex string is valid
            if (!hex || hex.length !== 7 || hex[0] !== '#') {
                console.warn('Invalid hex color for brightness:', hex);
                return 0; // Default to dark
            }
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            // Using standard luma formula
            return (0.299 * r + 0.587 * g + 0.114 * b);
        }

        function checkAnswer(selectedValue) {
            if (processingAnswer) return; // Prevent multiple clicks
            processingAnswer = true;

            // Correct value is *always* the name, to handle duplicates like gray/grey
            const correctValue = currentCorrectColor.name;
            const friendlyCorrectName = formatColorName(currentCorrectColor.name);
            const friendlyPickedName = formatColorName(selectedValue);

            if (selectedValue === correctValue) {
                // Correct Answer
                score++;
                feedbackEl.textContent = 'Correct!';
                feedbackEl.className = 'mt-6 text-center text-lg font-semibold h-8 text-green-500 dark:text-green-400 feedback-pop';
            } else {
                // Wrong Answer
                if (gameMode === 'colorToName') {
                    // Mode 1: Showed color, guessed name.
                    // Feedback: Tell them the correct name.
                    feedbackEl.textContent = `Wrong! The correct answer was ${friendlyCorrectName}`;
                } else {
                    // Mode 2: Showed name, guessed color.
                    // Feedback: Tell them what they picked.
                    // selectedValue is the name of the color they clicked.
                    feedbackEl.textContent = `Wrong! You picked ${friendlyPickedName}`;
                }
                feedbackEl.className = 'mt-6 text-center text-lg font-semibold h-8 text-red-500 dark:text-red-400 feedback-pop';
            }
 
            // Update scores
            scoreEl.textContent = score;
            guessesLeft--;
            guessesLeftEl.textContent = guessesLeft;

            // Wait a moment, then go to the next round
            setTimeout(nextRound, 1200);
        }

        function endGame() {
            finalScoreEl.textContent = score;
            rankEl.textContent = getRank(score);
            saveBestScore(); // This also updates the 'end-best-score' text
            
            gameScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
        }

        function getRank(score) {
            if (score <= 5) return "Color Pleb";
            if (score <= 10) return "Color Noob";
            if (score <= 15) return "Color Middle Manager";
            if (score <= 18) return "Color Connoisseur";
            if (score <= 20) return "Color Lord";
            return "Color Lord";
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', startGame);
        playAgainBtn.addEventListener('click', () => {
            endScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            loadBestScore(); // Update best score on start screen
        });
        
        // Help Modal Listeners
        helpBtn.addEventListener('click', showHelpModal);
        closeHelpBtn.addEventListener('click', hideHelpModal);
        // Also close modal if clicking on the background
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                hideHelpModal();
            }
        });

        // NEW: Library Select Listener
        librarySelect.addEventListener('change', async (e) => {
            const selectedFile = e.target.value;
            // Show a simple loading state in the help button?
            helpBtn.textContent = "Loading Library...";
            await loadColorLibrary(selectedFile);
            helpBtn.textContent = "Show Color Reference";
        });

        // --- Initial Load ---
        /**
         * Initializes the game by loading the default color library
         * and the user's best scores.
         */
        async function initializeGame() {
            // Get the default selected library from the dropdown
            const defaultLibraryFile = librarySelect.value;
            await loadColorLibrary(defaultLibraryFile);
            
            // Now load scores
            loadBestScore();
            
            // populateColorList() is already called by loadColorLibrary(),
            // so the help modal is ready.
        }

        // Start the game initialization
        initializeGame();

    </script>
</body>
</html>